@startuml SafeHeight_Monitor_Database_Schema

!define Table(name,desc) class name as "desc" << (T,#FFAAAA) >>
!define primary_key(x) <b><u>x</u></b>
!define foreign_key(x) <i>x</i>
!define not_null(x) <b>x</b>

skinparam linetype ortho
skinparam classAttributeIconSize 0

title Схема бази даних системи SafeHeight Monitor

' Core Entities
entity Worker {
  primary_key(WorkerId) : GUID
  not_null(FirstName) : VARCHAR(50)
  not_null(LastName) : VARCHAR(50)
  not_null(Email) : VARCHAR(100) UNIQUE
  not_null(PhoneNumber) : VARCHAR(20)
  not_null(EmployeeNumber) : VARCHAR(20) UNIQUE
  not_null(Position) : VARCHAR(100)
  not_null(CurrentStatus) : ENUM
  not_null(IsActive) : BOOLEAN
  not_null(MedicalCertificateExpiry) : DATE
  not_null(SafetyCertificateExpiry) : DATE
  not_null(CreatedAt) : DATETIME
  UpdatedAt : DATETIME
}

entity IoTDevice {
  primary_key(DeviceId) : GUID
  not_null(DeviceType) : ENUM
  not_null(SerialNumber) : VARCHAR(50) UNIQUE
  not_null(ManufacturerModel) : VARCHAR(100)
  not_null(FirmwareVersion) : VARCHAR(20)
  foreign_key(WorkerId) : GUID
  foreign_key(ZoneId) : GUID
  not_null(Status) : ENUM
  not_null(BatteryLevel) : INT
  not_null(LastConnected) : DATETIME
  not_null(IssuedDate) : DATE
}

entity SensorReading {
  primary_key(ReadingId) : GUID
  foreign_key(not_null(DeviceId)) : GUID
  not_null(Timestamp) : DATETIME <<INDEX>>
  not_null(Latitude) : DECIMAL(10,8)
  not_null(Longitude) : DECIMAL(11,8)
  not_null(Altitude) : DECIMAL(8,2)
  not_null(AccelerationX) : DECIMAL(8,4)
  not_null(AccelerationY) : DECIMAL(8,4)
  not_null(AccelerationZ) : DECIMAL(8,4)
  GyroscopeX : DECIMAL(8,4)
  GyroscopeY : DECIMAL(8,4)
  GyroscopeZ : DECIMAL(8,4)
  HeartRate : INT
  BodyTemperature : DECIMAL(4,2)
}

entity Alert {
  primary_key(AlertId) : GUID
  foreign_key(not_null(WorkerId)) : GUID
  foreign_key(not_null(DeviceId)) : GUID
  not_null(AlertType) : ENUM
  not_null(Severity) : ENUM
  RiskProbability : DECIMAL(5,2)
  not_null(Message) : VARCHAR(500)
  not_null(Timestamp) : DATETIME <<INDEX>>
  not_null(IsAcknowledged) : BOOLEAN
  foreign_key(AcknowledgedBy) : GUID
  AcknowledgedAt : DATETIME
  ResponseTime : INT
  Location : VARCHAR(200)
}

entity Zone {
  primary_key(ZoneId) : GUID
  not_null(ZoneName) : VARCHAR(100) UNIQUE
  Description : VARCHAR(500)
  not_null(GeofenceCoordinates) : TEXT
  not_null(RiskLevel) : ENUM
  MaximumHeight : DECIMAL(6,2)
  not_null(RequiresSafetyCert) : BOOLEAN
  not_null(IsActive) : BOOLEAN
  not_null(CreatedAt) : DATETIME
  UpdatedAt : DATETIME
}

entity SafetyReport {
  primary_key(ReportId) : GUID
  not_null(ReportDate) : DATE <<INDEX>>
  not_null(ReportType) : ENUM
  foreign_key(ZoneId) : GUID
  not_null(TotalAlerts) : INT
  not_null(WarningAlerts) : INT
  not_null(CriticalAlerts) : INT
  not_null(TotalWorkers) : INT
  AverageResponseTime : DECIMAL(8,2)
  foreign_key(not_null(GeneratedBy)) : GUID
  not_null(GeneratedAt) : DATETIME
  FilePath : VARCHAR(500)
}

entity User {
  primary_key(UserId) : GUID
  not_null(Username) : VARCHAR(50) UNIQUE
  not_null(Email) : VARCHAR(100) UNIQUE
  not_null(PasswordHash) : VARCHAR(256)
  not_null(Salt) : VARCHAR(128)
  foreign_key(not_null(RoleId)) : GUID
  not_null(FirstName) : VARCHAR(50)
  not_null(LastName) : VARCHAR(50)
  PhoneNumber : VARCHAR(20)
  not_null(IsActive) : BOOLEAN
  LastLogin : DATETIME
  not_null(CreatedAt) : DATETIME
  UpdatedAt : DATETIME
}

entity Role {
  primary_key(RoleId) : GUID
  not_null(RoleName) : VARCHAR(50) UNIQUE
  Description : VARCHAR(200)
  not_null(Permissions) : TEXT
}

entity EmergencyContact {
  primary_key(ContactId) : GUID
  foreign_key(not_null(WorkerId)) : GUID
  not_null(Name) : VARCHAR(100)
  not_null(Relationship) : VARCHAR(50)
  not_null(PhoneNumber) : VARCHAR(20)
  Email : VARCHAR(100)
  not_null(IsPrimary) : BOOLEAN
}

entity Incident {
  primary_key(IncidentId) : GUID
  foreign_key(not_null(WorkerId)) : GUID
  foreign_key(AlertId) : GUID
  not_null(IncidentType) : ENUM
  not_null(Severity) : ENUM
  not_null(Description) : TEXT
  not_null(Location) : VARCHAR(200)
  not_null(Timestamp) : DATETIME <<INDEX>>
  not_null(EmergencyServicesCalled) : BOOLEAN
  not_null(InvestigationStatus) : ENUM
  foreign_key(not_null(ReportedBy)) : GUID
  not_null(ReportedAt) : DATETIME
}

' Relationships
Worker ||--o{ IoTDevice : "assigned to"
Worker ||--o{ Alert : "generates"
Worker ||--o{ EmergencyContact : "has"
Worker ||--o{ Incident : "involved in"

IoTDevice ||--o{ SensorReading : "produces"
IoTDevice ||--o{ Alert : "triggers"
IoTDevice }o--|| Zone : "located in"

Zone ||--o{ IoTDevice : "contains"
Zone ||--o{ SafetyReport : "covered by"

Alert }o--|| User : "acknowledged by"

SafetyReport }o--|| User : "generated by"

User }o--|| Role : "has"

Incident }o--|| User : "reported by"
Incident }o--o| Alert : "caused by"

note right of Worker
  **Core Entity**
  Stores worker information
  Links to IoT devices, alerts,
  emergency contacts, and incidents
end note

note right of IoTDevice
  **IoT Hub Integration**
  Device registration and status
  Real-time connectivity tracking
  Battery and firmware management
end note

note right of SensorReading
  **Time Series Data**
  High-frequency sensor data
  (10Hz = ~3M records/day for 200 devices)
  Stored in Azure Time Series Insights
  or partitioned SQL tables
end note

note right of Alert
  **Real-time Alerts**
  Generated by AI/ML model
  Critical alerts: <2s latency
  Acknowledgement tracking
  Response time measurement
end note

note bottom of Zone
  **Geofencing**
  GeoJSON polygon coordinates
  Risk level classification
  Safety certification requirements
end note

note bottom of SafetyReport
  **Analytics & Compliance**
  Daily/Weekly/Monthly reports
  Aggregated statistics
  PDF generation and storage
end note

@enduml
