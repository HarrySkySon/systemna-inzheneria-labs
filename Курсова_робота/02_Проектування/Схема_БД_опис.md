# Схема таблиць бази даних

**Курсова робота з дисципліни "Системна інженерія програмного забезпечення"**

**Студент:** Постановський Ігор
**Група:** ІПЗм(д)-25

**Тема:** Веб-додаток моніторингу будівельних майданчиків з AI для запобігання падінням з висоти

---

## Опис структури бази даних

Система SafeHeight Monitor використовує реляційну базу даних для зберігання структурованих даних та NoSQL/Time Series DB для зберігання великих обсягів сенсорних даних у реальному часі.

### Архітектура даних

**Основна БД:** Azure SQL Database (реляційна БД)
**Time Series:** Azure Time Series Insights (для SensorReading)
**NoSQL:** Azure Cosmos DB (для Alerts у реальному часі)
**Blob Storage:** Azure Blob Storage (для PDF звітів)

---

## Основні таблиці

### 1. Worker (Працівники)

Центральна таблиця системи, що зберігає інформацію про працівників будівельного майданчику.

**Первинний ключ:** WorkerId (GUID)

**Основні поля:**
- FirstName, LastName - ПІБ працівника
- Email, PhoneNumber - контактна інформація
- EmployeeNumber - табельний номер (унікальний)
- CurrentStatus - поточний статус (Safe/Warning/Critical)
- MedicalCertificateExpiry, SafetyCertificateExpiry - терміни дії сертифікатів

**Зв'язки:**
- 1:N з IoTDevice - один працівник може мати декілька пристроїв
- 1:N з Alert - генерує попередження
- 1:N з EmergencyContact - має контактні особи
- 1:N з Incident - може бути залучений до інцидентів

---

### 2. IoTDevice (IoT Пристрої)

Таблиця для управління IoT пристроями (носимі датчики, браслети, шоломи з датчиками).

**Первинний ключ:** DeviceId (GUID)

**Основні поля:**
- DeviceType - тип пристрою (Wearable/Sensor/Beacon)
- SerialNumber - серійний номер (унікальний)
- Status - статус пристрою (Active/Offline/Faulty)
- BatteryLevel - рівень заряду батареї (0-100%)
- LastConnected - час останнього підключення

**Зовнішні ключі:**
- WorkerId → Worker (який працівник використовує)
- ZoneId → Zone (в якій зоні знаходиться)

**Зв'язки:**
- N:1 з Worker - призначений працівнику
- N:1 з Zone - розташований у зоні
- 1:N з SensorReading - генерує дані датчиків
- 1:N з Alert - генерує попередження

---

### 3. SensorReading (Показники датчиків)

Таблиця для зберігання даних з IoT датчиків у реальному часі. Висока частота записів (10 Hz = 10 записів/сек на пристрій).

**Первинний ключ:** ReadingId (GUID)

**Основні поля:**
- Timestamp - час зчитування (індексоване поле)
- Latitude, Longitude, Altitude - геолокація
- AccelerationX/Y/Z - дані акселерометра
- GyroscopeX/Y/Z - дані гіроскопа
- HeartRate - пульс
- BodyTemperature - температура тіла

**Зовнішні ключі:**
- DeviceId → IoTDevice

**Особливості:**
- Зберігається в Azure Time Series Insights для ефективної обробки великих обсягів даних
- Партиціонування за Timestamp для оптимізації запитів
- Приблизно 3 мільйони записів на день для 200 пристроїв

---

### 4. Alert (Попередження)

Таблиця для зберігання попереджень про ризики, згенерованих AI/ML моделлю.

**Первинний ключ:** AlertId (GUID)

**Основні поля:**
- AlertType - тип попередження (FallRisk/ZoneBreach/DeviceFault)
- Severity - серйозність (Warning/Critical)
- RiskProbability - ймовірність ризику (%)
- Timestamp - час генерації (індексоване)
- IsAcknowledged - чи підтверджено
- ResponseTime - час реакції (сек)

**Зовнішні ключі:**
- WorkerId → Worker
- DeviceId → IoTDevice
- AcknowledgedBy → User

**Особливості:**
- Критичні попередження мають латентність < 2 секунди
- Зберігається також в Cosmos DB для швидкого доступу у реальному часі

---

### 5. Zone (Робочі зони)

Таблиця для визначення робочих зон на будівельному майданчику.

**Первинний ключ:** ZoneId (GUID)

**Основні поля:**
- ZoneName - назва зони (унікальна)
- GeofenceCoordinates - координати меж (GeoJSON формат)
- RiskLevel - рівень ризику (Low/Medium/High)
- MaximumHeight - максимальна висота для роботи
- RequiresSafetyCert - чи потрібен сертифікат

**Зв'язки:**
- 1:N з IoTDevice - містить пристрої
- 1:N з SafetyReport - охоплюється звітами

---

### 6. SafetyReport (Звіти з безпеки)

Таблиця для зберігання згенерованих звітів з безпеки.

**Первинний ключ:** ReportId (GUID)

**Основні поля:**
- ReportDate - дата звіту (індексоване)
- ReportType - тип звіту (Daily/Weekly/Monthly)
- TotalAlerts, WarningAlerts, CriticalAlerts - статистика
- AverageResponseTime - середній час реакції
- FilePath - шлях до PDF файлу

**Зовнішні ключі:**
- ZoneId → Zone (якщо звіт по зоні)
- GeneratedBy → User

---

### 7. User (Користувачі системи)

Таблиця для зберігання облікових записів користувачів.

**Первинний ключ:** UserId (GUID)

**Основні поля:**
- Username - ім'я користувача (унікальне)
- Email - електронна пошта (унікальна)
- PasswordHash - хеш пароля (SHA-256)
- Salt - сіль для хешування
- LastLogin - час останнього входу

**Зовнішні ключі:**
- RoleId → Role

**Зв'язки:**
- N:1 з Role - належить до ролі
- 1:N з Alert (AcknowledgedBy) - підтверджує попередження
- 1:N з SafetyReport - генерує звіти
- 1:N з Incident (ReportedBy) - повідомляє про інциденти

---

### 8. Role (Ролі користувачів)

Таблиця для визначення ролей та прав доступу.

**Первинний ключ:** RoleId (GUID)

**Ролі системи:**
1. **Admin** (Системний адміністратор) - повний доступ
2. **Manager** (Менеджер проекту) - перегляд звітів, управління
3. **SafetyOfficer** (Інженер з охорони праці) - моніторинг, правила безпеки
4. **Foreman** (Бригадир) - управління зонами, моніторинг бригади
5. **Worker** (Працівник) - обмежений доступ, особисті дані

**Основні поля:**
- RoleName - назва ролі (унікальна)
- Permissions - JSON з правами доступу

---

### 9. EmergencyContact (Аварійні контакти)

Таблиця для зберігання контактних осіб працівників.

**Первинний ключ:** ContactId (GUID)

**Основні поля:**
- Name - ПІБ контактної особи
- Relationship - ступінь спорідненості
- PhoneNumber - телефон
- IsPrimary - чи основний контакт

**Зовнішні ключі:**
- WorkerId → Worker

---

### 10. Incident (Інциденти)

Таблиця для зберігання інформації про інциденти та аварії.

**Первинний ключ:** IncidentId (GUID)

**Основні поля:**
- IncidentType - тип інциденту (Fall/Injury/NearMiss)
- Severity - серйозність (Minor/Major/Fatal)
- Description - детальний опис
- EmergencyServicesCalled - чи викликали службу
- InvestigationStatus - статус розслідування

**Зовнішні ключі:**
- WorkerId → Worker
- AlertId → Alert (якщо спричинено попередженням)
- ReportedBy → User

---

## Індекси

Для оптимізації продуктивності створено індекси на наступних полях:

1. **SensorReading.Timestamp** - для швидкого пошуку за часом
2. **Alert.Timestamp** - для швидкого доступу до останніх попереджень
3. **Incident.Timestamp** - для аналізу інцидентів за період
4. **SafetyReport.ReportDate** - для швидкого доступу до звітів

## Обмеження цілісності

1. **CHECK Constraints:**
   - `BatteryLevel` між 0 та 100
   - `HeartRate` між 30 та 220
   - `Latitude` між -90 та 90
   - `Longitude` між -180 та 180
   - `RiskProbability` між 0 та 100

2. **UNIQUE Constraints:**
   - `Worker.Email`, `Worker.EmployeeNumber`
   - `IoTDevice.SerialNumber`
   - `User.Username`, `User.Email`
   - `Zone.ZoneName`
   - `Role.RoleName`

3. **FOREIGN KEY Constraints:**
   - Всі зв'язки між таблицями мають відповідні зовнішні ключі
   - ON DELETE CASCADE для EmergencyContact (при видаленні працівника)
   - ON DELETE RESTRICT для критичних зв'язків

## Особливості реалізації

### 1. Партиціонування

**SensorReading** таблиця партиціонована за `Timestamp`:
- Щомісячне партиціонування
- Автоматичне архівування старих даних (> 90 днів)
- Відокремлене зберігання в Time Series DB

### 2. Реплікація

- **Read Replicas** для звітів та аналітики
- **Geo-Replication** для disaster recovery
- **Backup** кожні 24 години з 90-денним збереженням

### 3. Шифрування

- **At Rest:** AES-256 шифрування бази даних
- **In Transit:** TLS 1.3 для всіх з'єднань
- **Sensitive Data:** Додаткове шифрування для PasswordHash та персональних даних

### 4. Оптимізація

- **Connection Pooling** для ефективного використання з'єднань
- **Query Optimization** через індекси та партиціонування
- **Caching** часто використовуваних даних в Redis

---

## ER-діаграма

Детальна ER-діаграма системи створена в PlantUML форматі та доступна у файлі `database_schema.puml`.

Для генерації зображення діаграми використайте:
- Online PlantUML Server: http://www.plantuml.com/plantuml/
- Або PlantUML desktop tool

---

**Дата створення:** 16 грудня 2025
